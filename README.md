# cognicity-alerts
Geospatial Alerting of Crowd-sourced Hazard Reports

System Overview
---------------
System is comprised of following components:
- SCHEMA in cognicity-schema PostgreSQL database (alerts.locations & alerts.users)
  - trigger performs spatial query using PostGIS extension to detect when new hazard reports are within specified distance of pre-registered alerting locations
  - issues alert using PostgreSQL NOTIFY
  - if multiple alerting locations are within range of new report, multiple NOTIFY alerts are issued
  - alerts schema maintains a log of activity for each alert location as a JSONB object in the alerts.locations table.
  - the activity log currently has not defined datatype - it is just free JSON
  - note that NOTIFY payloads are max of 8000 bytes. Thus, long logs will be truncated
  - if a location's status is set to unsubscribed then the database will not trigger a NOTIFY for that location
- MODULE in cogncity-notification service
  - receives NOTIFY alerts from database and processes to issue Amazon Web Services SNS notification
- COMPUTE
  - TODO
  - determines what to tell the user based on range to new report and log history at alert location
- REPLY LAMBDAS
  - Listen for response generated by COMPUTE and send to user via appropriate social network
  - SERVER
    - CRUD endpoint /alerts
      - register new users + alert locations
      - add new alert locations
      - append new log Information
      - un-subscribe users

Information Flow
----------------

### Register user
HTTP POST -> SERVER /alerts -> DATABASE

### Issue Alert
NEW REPORT -> DATABASE (alerts schema) -> COGNICITY-NOTIFICATION -> SNS -> COMPUTE -> REPLY LAMBDAS

Server Endpoints
----------------
Documented in the "alerts" branch of petabencana-docs. See https://github.com/urbanriskmap/petabencana-docs/tree/alerts

Standing up Alerts Dev Environment
----------------------------------
- create new database from cognicity-schema user alerts branch of Git
- stand-up cognicity-server using alerts branch, connected to above new database
- stand-up cognicity-notification-service /alerts branch
- make calls to server /alerts endpoint to register a new user/location
- make a call to the /cards endpoint to get a card ID and put a new report within 5km of registered alert location
- console output of cognicity-notification-service will show alert issued

##### TODO
- cognicity-notification-service -> pg-promise connection to LISTEN/NOTIFY with reconnect options
- cognicity-notification-service -> module to issue AWS SNS for alerts and replies
- cognicity-schema -> change 'watchers' channel name to 'replies'
- COMPUTE module
